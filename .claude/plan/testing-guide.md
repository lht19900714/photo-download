# 测试指南 - 页面刷新修复验证

**创建时间:** 2025-11-16
**相关修复:** fix-page-refresh-issue.md

---

## 🧪 测试目标

验证修复后的系统能够在每次循环中正确获取新上传的照片。

---

## 测试前准备

### 1. 备份现有数据（可选）
```bash
# 备份历史记录文件
cp downloaded.json downloaded.json.backup

# 备份照片目录
cp -r photos photos_backup
```

### 2. 清空历史记录（推荐）
```bash
# 删除历史记录，从头开始测试
rm downloaded.json
```

**说明:** 删除历史记录后，系统会重新下载所有照片，方便观察完整流程。

---

## 🔍 测试步骤

### 测试场景1: 验证首次加载

**步骤:**
1. 启动程序：
   ```bash
   uv run python photo_downloader.py
   ```

2. 观察日志输出

**预期结果:**
```
============================================================
PhotoPlus 照片自动下载工具启动
...
============================================================

正在访问页面...
✓ 页面首次加载成功
开始滚动加载所有照片...
滚动完成，共滚动 X 次，总计 Y 张照片
发现 Y 个照片元素，其中 Y 个为新照片（从索引 0 开始）
提取照片 [1/Y]: xxx.JPG
...
开始下载 Y 张新照片...
✓ 本次下载完成，成功 Y/Y 张照片
已处理到第 Y 张照片

等待 60 秒后进行下一次检查...
```

**验证点:**
- ✅ 日志显示 "✓ 页面首次加载成功"
- ✅ 成功提取并下载所有照片
- ✅ 无报错信息

---

### 测试场景2: 验证页面刷新（核心测试）

**前置条件:** 测试场景1已通过，程序仍在运行

**步骤:**
1. 等待60秒让第二次循环自动触发
2. 在等待期间，可以在直播网站手动上传1-2张新照片（如果可以）
3. 观察第二次循环的日志输出

**预期结果:**
```
正在刷新页面...
✓ 页面刷新成功（第 2 次循环）
开始滚动加载所有照片...
滚动完成，共滚动 X 次，总计 Y+N 张照片
发现 Y+N 个照片元素，其中 N 个为新照片（从索引 Y 开始）
提取照片 [Y+1/Y+N]: new_photo.JPG
...
开始下载 N 张新照片...
✓ 本次下载完成，成功 N/N 张照片
```

**验证点:**
- ✅ 日志显示 "正在刷新页面..." 而非 "正在访问页面..."
- ✅ 日志显示 "✓ 页面刷新成功（第 2 次循环）"
- ✅ **关键:** 如果有新照片，能检测到并下载（"其中 N 个为新照片"）
- ✅ 如果没有新照片，显示 "其中 0 个为新照片"

---

### 测试场景3: 验证连续刷新

**前置条件:** 测试场景2已通过

**步骤:**
1. 继续等待并观察第3、4次循环
2. 每次循环注意观察循环次数递增

**预期结果:**
```
第3次循环:
正在刷新页面...
✓ 页面刷新成功（第 3 次循环）
...

第4次循环:
正在刷新页面...
✓ 页面刷新成功（第 4 次循环）
...
```

**验证点:**
- ✅ 循环次数正确递增（2, 3, 4, ...）
- ✅ 每次都能检测到新照片（如果有）
- ✅ 无异常退出或报错

---

### 测试场景4: 验证异常恢复

**步骤:**
1. 程序运行中，断开网络连接10秒
2. 观察程序是否触发重试机制
3. 恢复网络连接
4. 观察程序是否恢复正常

**预期结果:**
```
✗ 访问失败 (1/10): [错误信息]
等待10秒后重试...
正在刷新页面...
✓ 页面刷新成功（第 X 次循环）
```

**验证点:**
- ✅ 网络中断时触发重试机制
- ✅ 网络恢复后程序继续运行
- ✅ 重试后能正常获取照片

---

## 📊 日志分析

### 关键日志标识

| 日志内容 | 含义 | 期望状态 |
|---------|------|---------|
| `正在访问页面...` | 首次访问 | 仅在第1次循环出现 |
| `正在刷新页面...` | 强制刷新 | 从第2次循环开始每次出现 |
| `✓ 页面首次加载成功` | 首次加载成功 | 仅在第1次循环出现 |
| `✓ 页面刷新成功（第 N 次循环）` | 刷新成功 | 从第2次循环开始，N递增 |
| `其中 X 个为新照片` | 检测到新照片 | X>0表示有新照片 |

### 问题判断

**🔴 问题现象1:** 第2次循环显示 "其中 0 个为新照片"，但实际网站有新照片
- **可能原因:** 增量索引仍有问题（方案1缺陷）
- **解决方案:** 切换到方案4（添加 `start_index=0` 参数）

**🔴 问题现象2:** 第2次循环报错 "reload() 失败"
- **可能原因:** Playwright版本兼容性问题
- **解决方案:** 回退使用 `page.goto()` 替代 `reload()`

**🔴 问题现象3:** 第2次循环后照片数量未增加
- **可能原因:** 页面缓存仍未被禁用
- **解决方案:** 检查 `extra_http_headers` 是否生效，或尝试其他缓存禁用方法

---

## 🛠️ 调试技巧

### 1. 启用无头模式调试（查看浏览器行为）

**修改 `config.py`:**
```python
HEADLESS = False  # 改为False
```

**观察要点:**
- 浏览器窗口是否真的刷新了（地址栏旋转图标）
- 网络请求是否从服务器获取（F12开发者工具）

### 2. 增加详细日志

**修改 `photo_downloader.py`:**
```python
logging.basicConfig(
    level=logging.DEBUG,  # 改为DEBUG
    ...
)
```

### 3. 缩短检查间隔（加速测试）

**修改 `config.py`:**
```python
CHECK_INTERVAL = 30  # 改为30秒
```

---

## ✅ 测试通过标准

满足以下所有条件视为测试通过：

1. ✅ 首次循环能正常获取并下载所有照片
2. ✅ 第2次及后续循环日志显示 "页面刷新成功"
3. ✅ **核心指标:** 当网站有新照片时，第2次循环能检测到（"其中 N 个为新照片" N>0）
4. ✅ 循环次数正确递增
5. ✅ 无异常退出或Python报错

---

## 📝 测试记录模板

```
测试日期: 2025-11-16
测试人员: [姓名]
环境: macOS / Python 3.11 / uv

场景1 - 首次加载:
- 状态: [ ] 通过 [ ] 失败
- 照片总数: ___
- 下载成功数: ___
- 备注: _______

场景2 - 页面刷新:
- 状态: [ ] 通过 [ ] 失败
- 第2次循环总照片数: ___
- 新照片数: ___
- 刷新日志: [ ] 正确 [ ] 错误
- 备注: _______

场景3 - 连续刷新:
- 状态: [ ] 通过 [ ] 失败
- 测试循环次数: ___
- 备注: _______

场景4 - 异常恢复:
- 状态: [ ] 通过 [ ] 失败 [ ] 未测试
- 备注: _______

总结:
[ ] 所有测试通过
[ ] 部分测试失败，需要进一步修复
[ ] 建议切换到方案4
```

---

## 🚨 如果测试失败

### 方案1不生效时的应对

**症状:** 第2次循环仍然检测不到新照片

**下一步行动:**
1. 确认修改已生效（检查代码是否保存）
2. 尝试完全重启程序
3. 如果仍失败，建议切换到**方案4**（更可靠）

**方案4快速切换指南:**
修改 `photo_downloader.py:332`：
```python
# 将这行
new_photos = await extractor.extract_photo_urls(page, history.last_processed_index)

# 改为
new_photos = await extractor.extract_photo_urls(page, 0)  # 固定从0开始
```

这样每次都提取所有照片，通过 `is_downloaded()` 去重。

---

**测试完成后请保存测试记录并反馈结果！**
