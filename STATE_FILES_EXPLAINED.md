# çŠ¶æ€æ–‡ä»¶è¯¦è§£

## âš ï¸ é‡è¦è¯´æ˜

`runtime-config.json` å’Œ `downloaded.json` **ä¸åº”è¯¥**æ·»åŠ åˆ° `.gitignore`ï¼

è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯ç³»ç»Ÿçš„"è®°å¿†"ï¼Œå¿…é¡»åœ¨ GitHub Actions è¿è¡Œä¹‹é—´ä¿æŒçŠ¶æ€ã€‚

---

## ğŸ“‹ æ–‡ä»¶è§’è‰²å¯¹æ¯”

| æ–‡ä»¶ | ä½œç”¨ | å­˜å‚¨ä½ç½® | æ˜¯å¦æäº¤ | è°åˆ›å»º | è°æ›´æ–° |
|------|------|---------|---------|--------|--------|
| **runtime-config.json** | è¿è¡ŒçŠ¶æ€é…ç½® | github_action åˆ†æ”¯ | âœ… å¿…é¡» | Web é¢æ¿ | Web é¢æ¿ + Actions |
| **downloaded.json** | ä¸‹è½½å†å²è®°å½• | github_action åˆ†æ”¯ | âœ… å¿…é¡» | Actions | Actions |
| **photos/** | ç…§ç‰‡æ–‡ä»¶ | æœ¬åœ° / Dropbox | âŒ ä¸æäº¤ | Actions | Actions |
| **config.py** | å¼€å‘é…ç½® | æ‰€æœ‰åˆ†æ”¯ | âš ï¸ æ³¨æ„å®‰å…¨ | å¼€å‘è€… | å¼€å‘è€… |

---

## ğŸ”„ runtime-config.json å®Œæ•´æµç¨‹

### æ–‡ä»¶ç»“æ„

```json
{
  "enabled": true,                    // æ˜¯å¦å¯ç”¨ç›‘æ§
  "interval": 60,                     // æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
  "clearHistory": false,              // æ˜¯å¦æ¸…é™¤å†å²
  "lastRunTime": "2025-01-17T10:30:00Z",  // ä¸Šæ¬¡è¿è¡Œæ—¶é—´
  "lastRunSuccess": true,             // ä¸Šæ¬¡è¿è¡Œç»“æœ
  "taskConfig": {
    "targetUrl": "https://...",       // ç›®æ ‡ URL
    "dropboxPath": "/photos"          // Dropbox è·¯å¾„
  }
}
```

### ç”Ÿå‘½å‘¨æœŸ

```
1. ç”¨æˆ·æ“ä½œ Web é¢æ¿
   â†“
   ç‚¹å‡»"å¼€å§‹ç›‘æ§"
   â†“
2. Web é¢æ¿è°ƒç”¨ GitHub API
   â†“
   PUT /repos/{owner}/{repo}/contents/runtime-config.json
   åˆ›å»ºæ–‡ä»¶å¹¶è®¾ç½®ï¼š
   - enabled: true
   - interval: ç”¨æˆ·é€‰æ‹©çš„é—´éš”
   - clearHistory: æ¥è‡ª checkbox
   â†“
3. æ–‡ä»¶æäº¤åˆ° github_action åˆ†æ”¯
   â†“
4. GitHub Actions æ¯ 5 åˆ†é’Ÿè§¦å‘ï¼ˆcronï¼‰
   â†“
5. github_actions_runner.py è¯»å–æ­¤æ–‡ä»¶
   â†“
   æ£€æŸ¥ enabled == true?
   â”œâ”€ false â†’ é€€å‡ºï¼ˆ< 5 ç§’ï¼‰
   â””â”€ true â†’ ç»§ç»­
       â†“
       æ£€æŸ¥è·ç¦» lastRunTime æ˜¯å¦æ»¡è¶³ interval?
       â”œâ”€ æœªæ»¡è¶³ â†’ é€€å‡ºï¼ˆ< 5 ç§’ï¼‰
       â””â”€ æ»¡è¶³ â†’ æ‰§è¡Œä¸‹è½½ä»»åŠ¡
           â†“
           ä»»åŠ¡å®Œæˆåæ›´æ–°ï¼š
           - lastRunTime: å½“å‰æ—¶é—´
           - lastRunSuccess: true/false
           - clearHistory: falseï¼ˆæ¸…é™¤æ ‡å¿—ä»…ç”Ÿæ•ˆä¸€æ¬¡ï¼‰
           â†“
           æäº¤æ›´æ–°åˆ° github_action åˆ†æ”¯
           â†“
6. ä¸‹æ¬¡ Actions è¿è¡Œæ—¶è¯»å–æ›´æ–°åçš„å€¼
```

### å¦‚æœæ·»åŠ åˆ° .gitignore ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

âŒ **é”™è¯¯åœºæ™¯**ï¼š

```
1. Web é¢æ¿åˆ›å»º runtime-config.jsonï¼ˆenabled: trueï¼‰
   â†“
2. GitHub Actions è¿è¡Œ
   â†“
3. è¯»å–æ–‡ä»¶æˆåŠŸ â†’ æ‰§è¡Œä»»åŠ¡ â†’ æ›´æ–° lastRunTime
   â†“
4. æäº¤æ—¶å‘ç°æ–‡ä»¶åœ¨ .gitignore â†’ æœªæäº¤
   â†“
5. ä¸‹æ¬¡ Actions è¿è¡Œ
   â†“
6. è¯»å–æ–‡ä»¶ â†’ lastRunTime ä»æ˜¯æ—§å€¼
   â†“
7. åˆ¤æ–­å·²æ»¡è¶³é—´éš” â†’ å†æ¬¡æ‰§è¡Œï¼ˆåº”è¯¥è·³è¿‡ï¼‰
   â†“
ç»“æœï¼šæ— æ³•æ­£ç¡®æ§åˆ¶è¿è¡Œé—´éš” âŒ
```

---

## ğŸ“š downloaded.json å®Œæ•´æµç¨‹

### æ–‡ä»¶ç»“æ„

```json
{
  "version": "2.0",
  "downloads": {
    "1060536x354blur2.jpg": {          // ç…§ç‰‡æŒ‡çº¹ï¼ˆç¼©ç•¥å›¾æ–‡ä»¶åï¼‰
      "original_filename": "2:30721.jpg",
      "thumbnail_url": "//pb.plusx.cn/.../1060536x354blur2.jpg~...",
      "download_time": "2025-01-17 10:30:15"
    },
    "å¦ä¸€ä¸ªæŒ‡çº¹": { ... }
  },
  "last_update": "2025-01-17 10:30:22"
}
```

### ç”Ÿå‘½å‘¨æœŸ

```
1. GitHub Actions è¿è¡Œ
   â†“
2. github_actions_runner.py æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   â”œâ”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºç©ºè®°å½• {}
   â””â”€ å­˜åœ¨ â†’ åŠ è½½å†å²è®°å½•
   â†“
3. æ‰«æç›´æ’­é¡µé¢æ‰€æœ‰ç…§ç‰‡çš„æŒ‡çº¹
   â†“
   ç¤ºä¾‹ï¼šæ‰¾åˆ° 100 å¼ ç…§ç‰‡çš„æŒ‡çº¹
   â†“
4. ä¸ downloaded.json å¯¹æ¯”
   â†“
   downloads ä¸­æœ‰ 85 æ¡è®°å½•
   â†“
   è®¡ç®—ï¼š100 - 85 = 15 å¼ æ–°ç…§ç‰‡
   â†“
5. ä»…ä¸‹è½½è¿™ 15 å¼ æ–°ç…§ç‰‡
   â†“
   æ¯ä¸‹è½½æˆåŠŸä¸€å¼ ï¼š
   - æ·»åŠ æŒ‡çº¹åˆ° downloads
   - ä¿å­˜ downloaded.json
   â†“
6. æ‰€æœ‰æ–°ç…§ç‰‡ä¸‹è½½å®Œæˆ
   â†“
   downloads ç°åœ¨æœ‰ 100 æ¡è®°å½•
   â†“
7. æäº¤ downloaded.json åˆ° github_action åˆ†æ”¯
   â†“
8. ä¸‹æ¬¡è¿è¡Œæ—¶è¯»å–è¿™ 100 æ¡è®°å½•
   â†“
   å¦‚æœé¡µé¢åˆæ–°å¢äº† 5 å¼ ç…§ç‰‡
   â†“
   ä»…ä¸‹è½½è¿™ 5 å¼ ï¼ˆè·³è¿‡å‰ 100 å¼ ï¼‰
```

### å¦‚æœæ·»åŠ åˆ° .gitignore ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

âŒ **é”™è¯¯åœºæ™¯**ï¼š

```
ç¬¬ä¸€æ¬¡è¿è¡Œï¼š
1. downloaded.json ä¸å­˜åœ¨ â†’ åˆ›å»ºç©ºè®°å½•
   â†“
2. æ‰«æé¡µé¢æ‰¾åˆ° 100 å¼ ç…§ç‰‡
   â†“
3. å…¨éƒ¨è§†ä¸ºæ–°ç…§ç‰‡ â†’ ä¸‹è½½ 100 å¼ 
   â†“
4. æ›´æ–° downloaded.jsonï¼ˆ100 æ¡è®°å½•ï¼‰
   â†“
5. æäº¤æ—¶å‘ç°æ–‡ä»¶åœ¨ .gitignore â†’ æœªæäº¤ âŒ
   â†“
ç¬¬äºŒæ¬¡è¿è¡Œï¼š
6. downloaded.json åœ¨è¿œç¨‹ä»“åº“ä¸å­˜åœ¨ï¼ˆè¢«å¿½ç•¥ï¼‰
   â†“
7. å†æ¬¡åˆ›å»ºç©ºè®°å½• â†’ æ‰«æé¡µé¢
   â†“
8. æ‰¾åˆ° 105 å¼ ç…§ç‰‡ï¼ˆæ–°å¢äº† 5 å¼ ï¼‰
   â†“
9. å…¨éƒ¨è§†ä¸ºæ–°ç…§ç‰‡ â†’ ä¸‹è½½ 105 å¼ ï¼ˆé‡å¤ä¸‹è½½å‰ 100 å¼ ï¼ï¼‰âŒ
   â†“
ç»“æœï¼šæ¯æ¬¡è¿è¡Œéƒ½é‡å¤ä¸‹è½½æ‰€æœ‰ç…§ç‰‡ âŒ
æµªè´¹æµé‡ã€Dropbox ç©ºé—´ã€Actions æ—¶é—´
```

---

## âœ… æ­£ç¡®çš„æ–‡ä»¶ç®¡ç†

### .gitignore åº”è¯¥åŒ…å«

```gitignore
# æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
photos/                   # æœ¬åœ°ç…§ç‰‡ç›®å½•ï¼ˆå¦‚æœå¯ç”¨æœ¬åœ°ä¿å­˜ï¼‰
*.log                     # æ—¥å¿—æ–‡ä»¶
.DS_Store                 # ç³»ç»Ÿæ–‡ä»¶
.venv/                    # è™šæ‹Ÿç¯å¢ƒ
```

### .gitignore ä¸åº”è¯¥åŒ…å«

```gitignore
# âŒ ä¸è¦æ·»åŠ ä»¥ä¸‹å†…å®¹
# runtime-config.json     # å¿…é¡»æäº¤ï¼
# downloaded.json         # å¿…é¡»æäº¤ï¼
```

### github_action åˆ†æ”¯åº”è¯¥åŒ…å«

```
github_action/
â”œâ”€â”€ .github/workflows/photo-download.yml  # å·¥ä½œæµé…ç½®
â”œâ”€â”€ web/                                   # å‰ç«¯æ–‡ä»¶
â”œâ”€â”€ photo_downloader.py                    # æ ¸å¿ƒä»£ç 
â”œâ”€â”€ github_actions_runner.py               # Actions è¿è¡Œå™¨
â”œâ”€â”€ runtime-config.json                    # âœ… è¿è¡ŒçŠ¶æ€
â”œâ”€â”€ downloaded.json                        # âœ… ä¸‹è½½å†å²
â””â”€â”€ å…¶ä»–ä»£ç æ–‡ä»¶...
```

---

## ğŸ” éªŒè¯æ–‡ä»¶çŠ¶æ€

### æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®æäº¤

```bash
# åˆ‡æ¢åˆ° github_action åˆ†æ”¯
git checkout github_action

# æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
git status

# åº”è¯¥çœ‹åˆ°ï¼š
# nothing to commit, working tree clean

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­
git ls-files | grep -E "(runtime-config|downloaded)\.json"

# å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å·²æäº¤ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
# runtime-config.json
# downloaded.json
```

### å¦‚æœæ–‡ä»¶è¢«æ„å¤–å¿½ç•¥

```bash
# ä» .gitignore ä¸­ç§»é™¤
# ç¼–è¾‘ .gitignore åˆ é™¤ç›¸å…³è¡Œ

# å¼ºåˆ¶æ·»åŠ æ–‡ä»¶
git add -f runtime-config.json downloaded.json

# æäº¤
git commit -m "Add state files to version control"

# æ¨é€
git push
```

---

## ğŸ“Š æ–‡ä»¶å¤§å°å’Œæ€§èƒ½

### runtime-config.json
- **å¤§å°**: ~200-500 å­—èŠ‚
- **æ›´æ–°é¢‘ç‡**: æ¯æ¬¡ Actions è¿è¡Œï¼ˆçº¦ 1 å°æ—¶ 1 æ¬¡ï¼‰
- **æ€§èƒ½å½±å“**: æå°ï¼ŒGit å¤„ç†æ•ˆç‡é«˜

### downloaded.json
- **åˆå§‹å¤§å°**: ~100 å­—èŠ‚
- **å¢é•¿é€Ÿåº¦**: çº¦ 200 å­—èŠ‚/å¼ ç…§ç‰‡
- **ç¤ºä¾‹è®¡ç®—**:
  - 100 å¼ ç…§ç‰‡ â‰ˆ 20 KB
  - 1000 å¼ ç…§ç‰‡ â‰ˆ 200 KB
  - 10000 å¼ ç…§ç‰‡ â‰ˆ 2 MB
- **æ›´æ–°é¢‘ç‡**: æ¯æ¬¡æœ‰æ–°ç…§ç‰‡æ—¶
- **æ€§èƒ½å½±å“**: å°ï¼ŒJSON è§£æå¾ˆå¿«

### Git ä»“åº“å¤§å°å½±å“
- å³ä½¿æ¯å¤©æ›´æ–° 10 æ¬¡ï¼Œä¸€å¹´ä¹Ÿä»…å¢åŠ çº¦ ~100 KB å†å²
- Git ä¼šå‹ç¼©å†å²è®°å½•ï¼Œå®é™…å¢é•¿æ›´å°
- å®Œå…¨åœ¨å¯æ¥å—èŒƒå›´å†…

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ•°æ®åº“ï¼Ÿ
A:
- GitHub Actions æ²¡æœ‰æŒä¹…åŒ–æ•°æ®åº“
- JSON æ–‡ä»¶ + Git æ˜¯æœ€ç®€å•å¯é çš„æ–¹æ¡ˆ
- æ— éœ€é¢å¤–æœåŠ¡ï¼Œå®Œå…¨å…è´¹

### Q: æ–‡ä»¶ä¼šä¸ä¼šæ— é™å¢é•¿ï¼Ÿ
A:
- `runtime-config.json` å›ºå®šå¤§å°ï¼Œä¸ä¼šå¢é•¿
- `downloaded.json` ä¼šéšç…§ç‰‡æ•°é‡å¢é•¿
- å¦‚æœæ‹…å¿ƒè¿‡å¤§ï¼Œå¯ä»¥å®šæœŸ"æ¸…é™¤å†å²"é‡æ–°å¼€å§‹

### Q: å¦‚ä½•é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼Ÿ
A:
1. å‹¾é€‰ Web é¢æ¿çš„"æ¸…é™¤å†å²è®°å½•" â†’ Actions åˆ é™¤ `downloaded.json`
2. æˆ–è€…æ‰‹åŠ¨åœ¨ GitHub åˆ é™¤è¿™ä¸¤ä¸ªæ–‡ä»¶
3. æˆ–è€…åˆ é™¤æ•´ä¸ª `github_action` åˆ†æ”¯é‡æ–°åˆ›å»º

### Q: æ–‡ä»¶å†²çªæ€ä¹ˆåŠï¼Ÿ
A:
- Web é¢æ¿å’Œ Actions ä½¿ç”¨ GitHub API æ›´æ–°æ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨å¤„ç† SHA
- å¦‚æœæ‰‹åŠ¨ç¼–è¾‘äº†æ–‡ä»¶å¯èƒ½å¯¼è‡´å†²çª
- Actions ä»£ç ä¸­å·²å®ç° `git pull --rebase` è‡ªåŠ¨è§£å†³

---

## ğŸ“– æ€»ç»“

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. âœ… çŠ¶æ€æ–‡ä»¶å¿…é¡»é€šè¿‡ Git åœ¨è¿è¡Œä¹‹é—´å…±äº«
2. âœ… GitHub Actions æ˜¯æ— çŠ¶æ€çš„ï¼Œæ¯æ¬¡è¿è¡Œéƒ½æ˜¯å…¨æ–°ç¯å¢ƒ
3. âœ… åªæœ‰ Git ä»“åº“ä¸­çš„æ–‡ä»¶å¯ä»¥åœ¨è¿è¡Œä¹‹é—´ä¿æŒ
4. âŒ .gitignore çš„æ–‡ä»¶æ— æ³•åœ¨è¿è¡Œä¹‹é—´å…±äº«

**è®°ä½**ï¼š
- `runtime-config.json` = ç³»ç»Ÿçš„"å¼€å…³å’Œæ—¶é’Ÿ"
- `downloaded.json` = ç³»ç»Ÿçš„"è®°å¿†"
- ä¸¤è€…ç¼ºä¸€ä¸å¯ï¼Œéƒ½å¿…é¡»æäº¤åˆ° Gitï¼
